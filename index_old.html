<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PQ Dart League ‚Äì Season 10</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh;padding:10px}
.container{max-width:1400px;margin:0 auto}
.header{text-align:center;color:#fff;margin-bottom:18px}
.header h1{font-size:clamp(1.4rem,5vw,2.4rem);text-shadow:2px 2px 4px rgba(0,0,0,.3);margin-bottom:6px}
.header p{font-size:clamp(.85rem,2.5vw,1.1rem);opacity:.9}
.sync{position:fixed;top:8px;right:8px;padding:7px 14px;border-radius:20px;font-size:.82rem;font-weight:600;color:#fff;z-index:999;box-shadow:0 2px 8px rgba(0,0,0,.2);cursor:pointer}
.sync.ok{background:#4caf50}.sync.working{background:#ff9800}.sync.fail{background:#e53935}
.venue{background:rgba(255,255,255,.18);padding:10px;border-radius:8px;text-align:center;color:#fff;margin-bottom:12px;font-size:clamp(.82rem,2.2vw,1rem)}
.rules{background:rgba(255,255,255,.95);padding:11px 16px;border-radius:8px;margin-bottom:12px;font-size:clamp(.72rem,1.9vw,.88rem);color:#333}
.rules h4{color:#1e3c72;margin-bottom:6px}
.rules ul{margin-left:16px}
.tabs{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.tab{padding:9px 15px;background:rgba(255,255,255,.18);border:2px solid rgba(255,255,255,.28);color:#fff;font-size:clamp(.78rem,2vw,.95rem);font-weight:600;cursor:pointer;border-radius:8px;white-space:nowrap;transition:all .25s}
.tab:hover{background:rgba(255,255,255,.28)}.tab.on{background:#fff;color:#1e3c72}
.card{background:#fff;border-radius:12px;padding:clamp(14px,3vw,28px);box-shadow:0 10px 30px rgba(0,0,0,.3);overflow-x:auto}
.tab-pane{display:none}.tab-pane.on{display:block}
.week{margin-bottom:18px;padding:14px;border-radius:8px}
.week:nth-child(odd){background:#f0f4f8}.week:nth-child(even){background:#f9f9f9}
.week-head{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.week-head span{font-size:clamp(1.05rem,2.8vw,1.4rem);font-weight:600;color:#1e3c72}
.gt-badge{background:#1e3c72;color:#fff;padding:5px 11px;border-radius:18px;font-size:clamp(.76rem,1.9vw,.95rem)}
.slot{margin-bottom:14px;border-left:4px solid #1e3c72;padding:11px;border-radius:4px}
.slot:nth-child(odd){background:rgba(255,255,255,.5)}.slot:nth-child(even){background:rgba(255,255,255,.3)}
.slot-time{font-size:clamp(.95rem,2.3vw,1.15rem);font-weight:600;color:#1e3c72;margin-bottom:9px}
.boards{display:grid;grid-template-columns:repeat(auto-fit,minmax(min(100%,330px),1fr));gap:11px}
.board{background:#fff;padding:11px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.board.makeup{background:#fff8e1;border-left:4px solid #f57c00}
.board.makeup.booked{background:#e3f2fd;border-left-color:#2196F3}
.board.cancelled{background:#ffebee;border-left:4px solid #e53935}
.board.filled{background:#fff;border-left:4px solid #78909c}
.blbl{font-size:.76rem;font-weight:600;color:#666;text-transform:uppercase;margin-bottom:7px}
.rescheduled-badge{background:#2196F3;color:#fff;padding:2px 7px;border-radius:4px;font-size:.68rem;display:inline-block;margin-bottom:5px}
.orig-info{background:#fff3cd;padding:7px;border-radius:4px;font-size:.72rem;margin-bottom:7px;color:#856404;line-height:1.45}
.team-row{display:flex;justify-content:space-between;align-items:center;padding:7px;background:#f9f9f9;border-radius:4px;margin-bottom:4px;gap:6px}
.team-row .name{flex:1;font-size:clamp(.78rem,1.9vw,.92rem);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.team-row .num{font-weight:600;color:#1e3c72;margin-right:4px}
.score-in{width:46px;padding:5px 3px;border:2px solid #e0e0e0;border-radius:4px;text-align:center;font-weight:600;font-size:.95rem}
.score-in:focus{outline:none;border-color:#1e3c72}
.score-in:disabled{background:#eee;color:#999;cursor:not-allowed}
.vs{text-align:center;color:#999;font-size:.76rem;font-weight:600;margin:2px 0}
.h2h{margin-top:9px;padding:9px;background:#f5f5f5;border-radius:5px}
.h2h-head{font-weight:600;font-size:clamp(.72rem,1.9vw,.82rem);color:#666;margin-bottom:5px}
.h2h-row{display:flex;justify-content:space-between;align-items:center;padding:5px;background:#fff;border-radius:3px;margin-bottom:3px;font-size:clamp(.72rem,1.9vw,.82rem);gap:6px}
.h2h-row .players{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.h2h-row select{padding:3px;border:1px solid #ddd;border-radius:3px;font-size:.78rem;max-width:96px}
.h2h-row select:disabled{background:#eee;color:#999}
.pts-row{margin-top:8px;padding:7px;background:#e8f5e9;border-radius:4px;font-size:clamp(.72rem,1.9vw,.82rem);display:flex;justify-content:space-between;gap:6px;flex-wrap:wrap}
.pts-row.tied{background:#fff3cd}
.actions{margin-top:9px;padding-top:9px;border-top:1px solid #e8e8e8;display:flex;gap:5px;flex-wrap:wrap}
.btn-sm{padding:5px 10px;border:none;border-radius:4px;cursor:pointer;font-size:clamp(.7rem,1.8vw,.8rem);font-weight:600;transition:filter .2s}
.btn-sm:hover{filter:brightness(.88)}
.btn-warn{background:#f57c00;color:#fff}.btn-danger{background:#e53935;color:#fff}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;overflow-y:auto}
.modal-bg.on{display:flex;align-items:flex-start;justify-content:center;padding:24px 10px}
.modal{background:#fff;border-radius:12px;padding:22px;max-width:580px;width:100%;max-height:88vh;overflow-y:auto;margin:auto;box-shadow:0 12px 40px rgba(0,0,0,.3)}
.modal h3{color:#1e3c72;margin-bottom:14px;font-size:clamp(1.05rem,2.8vw,1.4rem)}
.match-box{background:#e3f2fd;padding:11px;border-radius:6px;margin-bottom:14px;font-size:clamp(.82rem,2vw,.92rem)}
.match-box strong{display:block;margin-bottom:3px;color:#1e3c72}
.gt-sm{background:#1e3c72;color:#fff;padding:3px 9px;border-radius:10px;font-size:.76rem;display:inline-block;margin-top:3px}
.slots-wrap{background:#e8f5e9;padding:11px;border-radius:7px;margin:11px 0}
.slots-wrap h4{color:#2e7d32;margin-bottom:7px;font-size:clamp(.85rem,2.2vw,.96rem)}
.slot-opt{padding:9px;background:#fff;border-radius:4px;margin-bottom:7px;cursor:pointer;border:2px solid #e0e0e0;transition:all .18s;font-size:clamp(.82rem,2vw,.92rem)}
.slot-opt:hover{border-color:#4caf50;background:#f1f8f4}
.slot-opt.sel{border-color:#4caf50;background:#e8f5e9}
.no-slots{background:#fff3cd;padding:11px;border-radius:7px;color:#856404;margin:11px 0;font-size:clamp(.82rem,2vw,.92rem)}
.modal-btns{display:flex;gap:9px;margin-top:14px;flex-wrap:wrap}
.modal-btns button{flex:1;min-width:90px;padding:9px;border:none;border-radius:5px;font-size:.88rem;font-weight:600;cursor:pointer}
.modal-btns .confirm{background:#1e3c72;color:#fff}.modal-btns .confirm:disabled{background:#aaa;cursor:not-allowed}
.modal-btns .cancel{background:#f57c00;color:#fff}
.tbl{width:100%;border-collapse:collapse;margin-top:12px;font-size:clamp(.72rem,1.9vw,.88rem)}
.tbl th,.tbl td{padding:9px 5px;text-align:left;border-bottom:1px solid #e8e8e8}
.tbl th{background:#f5f5f5;font-weight:600;color:#444;position:sticky;top:0;z-index:2}
.tbl tr:hover{background:#fafafa}
.place{display:inline-block;padding:2px 9px;border-radius:18px;font-weight:600;font-size:clamp(.68rem,1.8vw,.84rem);white-space:nowrap}
.p1{background:#FFD700;color:#333}.p2{background:#C0C0C0;color:#333}.p3{background:#CD7F32;color:#fff}.p-{background:#e0e0e0;color:#666}
.payouts{background:#fff3cd;padding:14px;border-radius:8px;margin-bottom:14px}
.payouts h3{color:#856404;margin-bottom:8px;font-size:clamp(.95rem,2.4vw,1.15rem)}
.payout-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(min(100%,200px),1fr));gap:10px;margin-top:10px}
.payout-card{background:#fff;padding:11px;border-radius:6px;font-size:clamp(.72rem,1.9vw,.88rem)}
.stat-card{background:#fff;padding:14px;border-radius:8px;margin-bottom:14px;box-shadow:0 2px 5px rgba(0,0,0,.08)}
.stat-card h3{color:#1e3c72;margin-bottom:10px;font-size:clamp(.95rem,2.4vw,1.2rem)}
@media(max-width:640px){.boards{grid-template-columns:1fr}.tbl th,.tbl td{padding:7px 3px}}
</style>
</head>
<body>
<div id="app" class="container"></div>
<div class="sync working" id="sync" onclick="manualRefresh()" title="Click to refresh">‚è≥ Loading</div>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3 id="modalTitle">Reschedule</h3>
    <div id="modalBody"></div>
    <div class="modal-btns">
      <button class="confirm" id="confirmBtn" onclick="confirmReschedule()">Confirm</button>
      <button class="cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzLFUEqRgNcWYNSieVFfjDs8JdcM_cOw6EBLH2aoOtY3iKaHiJYb19YspKn-QB8l4PJ/exec';
var rescheduleCtx = null;
var selectedSlot = null;

// ============================================================
// HARDCODED SCHEDULE ‚Äì used if Google Sheets fetch fails
// Weeks 1-4 have scores from PDF. Weeks 5-12 are empty.
// 3 unplayed games: W2 12v7, W3 6v5, W4 5v1
// ============================================================
function getHardcodedSchedule(){
return [
{week:1,date:"1/5",type:"Cricket",timeSlots:[
  {time:"6:30 PM",boards:[
    {board:1,team1:5,team2:12,matchScore1:0,matchScore2:3,h2h:[{p1:5.1,p2:12.1,w:12.1},{p1:5.1,p2:12.2,w:12.2},{p1:5.2,p2:12.1,w:12.1},{p1:5.2,p2:12.2,w:5.2}]},
    {board:2,team1:2,team2:11,matchScore1:3,matchScore2:2,h2h:[{p1:2.1,p2:11.1,w:2.1},{p1:2.1,p2:11.2,w:2.1},{p1:2.2,p2:11.1,w:11.1},{p1:2.2,p2:11.2,w:11.2}]},
    {board:3,makeup:true}
  ]},
  {time:"8:00 PM",boards:[
    {board:1,team1:10,team2:8,matchScore1:3,matchScore2:2,h2h:[{p1:10.1,p2:8.1,w:10.1},{p1:10.1,p2:8.2,w:8.2},{p1:10.2,p2:8.1,w:8.1},{p1:10.2,p2:8.2,w:10.2}]},
    {board:2,team1:1,team2:4,matchScore1:3,matchScore2:2,h2h:[{p1:1.1,p2:4.1,w:1.1},{p1:1.1,p2:4.2,w:1.1},{p1:1.2,p2:4.1,w:4.1},{p1:1.2,p2:4.2,w:4.2}]},
    {board:3,makeup:true}
  ]},
  {time:"9:30 PM",boards:[
    {board:1,team1:7,team2:3,matchScore1:3,matchScore2:2,h2h:[{p1:7.1,p2:3.1,w:7.1},{p1:7.1,p2:3.2,w:7.1},{p1:7.2,p2:3.1,w:3.1},{p1:7.2,p2:3.2,w:3.2}]},
    {board:2,team1:6,team2:9,matchScore1:0,matchScore2:3,h2h:[{p1:6.1,p2:9.1,w:9.1},{p1:6.1,p2:9.2,w:9.2},{p1:6.2,p2:9.1,w:9.1},{p1:6.2,p2:9.2,w:6.2}]},
    {board:3,makeup:true}
  ]}
]},
{week:2,date:"1/12",type:"301",timeSlots:[
  {time:"6:30 PM",boards:[
    {board:1,team1:9,team2:1,matchScore1:3,matchScore2:0,h2h:[{p1:9.1,p2:1.1,w:9.1},{p1:9.1,p2:1.2,w:9.1},{p1:9.2,p2:1.1,w:9.2},{p1:9.2,p2:1.2,w:1.2}]},
    {board:2,team1:4,team2:10,matchScore1:1,matchScore2:3,h2h:[{p1:4.1,p2:10.1,w:10.1},{p1:4.1,p2:10.2,w:10.2},{p1:4.2,p2:10.1,w:10.1},{p1:4.2,p2:10.2,w:4.2}]},
    {board:3,makeup:true}
  ]},
  {time:"8:00 PM",boards:[
    {board:1,team1:3,team2:8,matchScore1:0,matchScore2:3,h2h:[{p1:3.1,p2:8.1,w:8.1},{p1:3.1,p2:8.2,w:8.2},{p1:3.2,p2:8.1,w:8.1},{p1:3.2,p2:8.2,w:3.2}]},
    {board:2,team1:12,team2:7,matchScore1:null,matchScore2:null,h2h:[]},
    {board:3,makeup:true}
  ]},
  {time:"9:30 PM",boards:[
    {board:1,team1:5,team2:2,matchScore1:3,matchScore2:1,h2h:[{p1:5.1,p2:2.1,w:5.1},{p1:5.1,p2:2.2,w:2.2},{p1:5.2,p2:2.1,w:2.1},{p1:5.2,p2:2.2,w:5.2}]},
    {board:2,team1:11,team2:6,matchScore1:3,matchScore2:1,h2h:[{p1:11.1,p2:6.1,w:11.1},{p1:11.1,p2:6.2,w:11.1},{p1:11.2,p2:6.1,w:11.2},{p1:11.2,p2:6.2,w:6.2}]},
    {board:3,makeup:true}
  ]}
]},
{week:3,date:"1/19",type:"Cheers Cricket",timeSlots:[
  {time:"6:30 PM",boards:[
    {board:1,team1:8,team2:12,matchScore1:3,matchScore2:1,h2h:[{p1:8.1,p2:12.1,w:12.1},{p1:8.1,p2:12.2,w:8.1},{p1:8.2,p2:12.1,w:8.2},{p1:8.2,p2:12.2,w:12.2}]},
    {board:2,team1:6,team2:5,matchScore1:null,matchScore2:null,h2h:[]},
    {board:3,makeup:true}
  ]},
  {time:"8:00 PM",boards:[
    {board:1,team1:4,team2:9,matchScore1:0,matchScore2:3,h2h:[{p1:4.1,p2:9.1,w:9.1},{p1:4.1,p2:9.2,w:9.2},{p1:4.2,p2:9.1,w:9.1},{p1:4.2,p2:9.2,w:4.2}]},
    {board:2,team1:2,team2:7,matchScore1:2,matchScore2:3,h2h:[{p1:2.1,p2:7.1,w:7.1},{p1:2.1,p2:7.2,w:7.2},{p1:2.2,p2:7.1,w:7.1},{p1:2.2,p2:7.2,w:7.2}]},
    {board:3,makeup:true}
  ]},
  {time:"9:30 PM",boards:[
    {board:1,team1:1,team2:11,matchScore1:0,matchScore2:3,h2h:[{p1:1.1,p2:11.1,w:1.1},{p1:1.1,p2:11.2,w:11.2},{p1:1.2,p2:11.1,w:11.1},{p1:1.2,p2:11.2,w:11.2}]},
    {board:2,team1:10,team2:3,matchScore1:0,matchScore2:3,h2h:[{p1:10.1,p2:3.1,w:3.1},{p1:10.1,p2:3.2,w:3.2},{p1:10.2,p2:3.1,w:3.1},{p1:10.2,p2:3.2,w:10.2}]},
    {board:3,makeup:true}
  ]}
]},
{week:4,date:"1/26",type:"501",timeSlots:[
  {time:"6:30 PM",boards:[
    {board:1,team1:9,team2:10,matchScore1:3,matchScore2:1,h2h:[{p1:9.1,p2:10.1,w:9.1},{p1:9.1,p2:10.2,w:9.1},{p1:9.2,p2:10.1,w:10.1},{p1:9.2,p2:10.2,w:10.2}]},
    {board:2,team1:7,team2:6,matchScore1:3,matchScore2:1,h2h:[{p1:7.1,p2:6.1,w:7.1},{p1:7.1,p2:6.2,w:7.1},{p1:7.2,p2:6.1,w:6.1},{p1:7.2,p2:6.2,w:6.2}]},
    {board:3,makeup:true}
  ]},
  {time:"8:00 PM",boards:[
    {board:1,team1:8,team2:2,matchScore1:3,matchScore2:1,h2h:[{p1:8.1,p2:2.1,w:8.1},{p1:8.1,p2:2.2,w:2.2},{p1:8.2,p2:2.1,w:8.2},{p1:8.2,p2:2.2,w:8.2}]},
    {board:2,team1:5,team2:1,matchScore1:null,matchScore2:null,h2h:[]},
    {board:3,makeup:true}
  ]},
  {time:"9:30 PM",boards:[
    {board:1,team1:12,team2:3,matchScore1:3,matchScore2:1,h2h:[{p1:12.1,p2:3.1,w:12.1},{p1:12.1,p2:3.2,w:3.2},{p1:12.2,p2:3.1,w:12.2},{p1:12.2,p2:3.2,w:12.2}]},
    {board:2,team1:11,team2:4,matchScore1:3,matchScore2:2,h2h:[{p1:11.1,p2:4.1,w:11.1},{p1:11.1,p2:4.2,w:11.1},{p1:11.2,p2:4.1,w:4.1},{p1:11.2,p2:4.2,w:4.2}]},
    {board:3,makeup:true}
  ]}
]},
{week:5,date:"2/2",type:"Cricket",timeSlots:[
  {time:"6:30 PM",boards:[{board:1,team1:1,team2:7,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:2,team2:3,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"8:00 PM",boards:[{board:1,team1:6,team2:8,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:4,team2:5,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"9:30 PM",boards:[{board:1,team1:10,team2:12,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:9,team2:11,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]}
]},
{week:6,date:"2/9",type:"301",timeSlots:[
  {time:"6:30 PM",boards:[{board:1,team1:8,team2:1,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:5,team2:9,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"8:00 PM",boards:[{board:1,team1:12,team2:2,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:7,team2:4,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"9:30 PM",boards:[{board:1,team1:3,team2:6,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:11,team2:10,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]}
]},
{week:7,date:"2/23",type:"Cheers Cricket",timeSlots:[
  {time:"6:30 PM",boards:[{board:1,team1:6,team2:12,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:4,team2:8,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"8:00 PM",boards:[{board:1,team1:11,team2:5,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:1,team2:3,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"9:30 PM",boards:[{board:1,team1:2,team2:10,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:9,team2:7,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]}
]},
{week:8,date:"3/2",type:"501",timeSlots:[
  {time:"6:30 PM",boards:[{board:1,team1:2,team2:6,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:10,team2:5,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"8:00 PM",boards:[{board:1,team1:3,team2:4,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:12,team2:1,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"9:30 PM",boards:[{board:1,team1:8,team2:9,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:7,team2:11,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]}
]},
{week:9,date:"3/9",type:"Cricket",timeSlots:[
  {time:"6:30 PM",boards:[{board:1,team1:4,team2:12,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:5,team2:7,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"8:00 PM",boards:[{board:1,team1:9,team2:3,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:6,team2:10,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"9:30 PM",boards:[{board:1,team1:1,team2:2,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:11,team2:8,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]}
]},
{week:10,date:"3/16",type:"501",timeSlots:[
  {time:"6:30 PM",boards:[{board:1,team1:12,team2:9,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:8,team2:5,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"8:00 PM",boards:[{board:1,team1:2,team2:4,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:3,team2:11,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"9:30 PM",boards:[{board:1,team1:10,team2:7,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:6,team2:1,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]}
]},
{week:11,date:"3/23",type:"Cheers Cricket",timeSlots:[
  {time:"6:30 PM",boards:[{board:1,team1:4,team2:6,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:7,team2:8,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"8:00 PM",boards:[{board:1,team1:5,team2:3,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:9,team2:2,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]},
  {time:"9:30 PM",boards:[{board:1,team1:1,team2:10,matchScore1:null,matchScore2:null,h2h:[]},{board:2,team1:11,team2:12,matchScore1:null,matchScore2:null,h2h:[]},{board:3,makeup:true}]}
]},
{week:12,date:"3/30",type:"Playoffs",timeSlots:[
  {time:"6:30 PM",boards:[{board:1,team1:null,team2:null,matchScore1:null,matchScore2:null,h2h:[],note:"Playoff TBD"},{board:2,team1:null,team2:null,matchScore1:null,matchScore2:null,h2h:[],note:"Playoff TBD"},{board:3,makeup:true}]},
  {time:"8:00 PM",boards:[{board:1,team1:null,team2:null,matchScore1:null,matchScore2:null,h2h:[],note:"Playoff TBD"},{board:2,team1:null,team2:null,matchScore1:null,matchScore2:null,h2h:[],note:"Playoff TBD"},{board:3,makeup:true}]},
  {time:"9:30 PM",boards:[{board:1,team1:null,team2:null,matchScore1:null,matchScore2:null,h2h:[],note:"Playoff TBD"},{board:2,team1:null,team2:null,matchScore1:null,matchScore2:null,h2h:[],note:"Playoff TBD"},{board:3,makeup:true}]}
]}
];
}

var schedule = getHardcodedSchedule();

var TEAMS = {
  1:{p1:'Bill',p2:'Ben F',name:'Projectile Dysfunction'},
  2:{p1:'Matt D',p2:'Miles',name:'Your Mom Knows Our Name'},
  3:{p1:'Trent',p2:'Travis',name:'Not the Best But the Tallest'},
  4:{p1:'Frankie',p2:'Rich',name:'Decent Darts'},
  5:{p1:'Omar',p2:'Bernie',name:'Won Hit Wonders'},
  6:{p1:'Ben A',p2:'Efrain',name:'Lefty-Righty and the Bullseye'},
  7:{p1:'Mark',p2:'Tim',name:'Marksmen'},
  8:{p1:'Clint',p2:'Brandon',name:'PQ Cork Dorks'},
  9:{p1:'Dr. Michael',p2:'Howard',name:'Double Doctors'},
  10:{p1:'Nate',p2:'Geo',name:'DFWG'},
  11:{p1:'Jorge',p2:'Jack',name:'Darts of Hazards'},
  12:{p1:'Joe P',p2:'Matthew B',name:'Flights of Fury'}
};

// ============================================================
// SYNC
// ============================================================
function setSyncBadge(state,label){ var e=document.getElementById('sync'); e.className='sync '+state; e.textContent=label; }

async function fetchSchedule(){
  setSyncBadge('working','üîÑ');
  try {
    var r = await fetch(SCRIPT_URL+'?action=getSchedule');
    var d = await r.json();
    if(d.success&&d.schedule){ schedule=d.schedule; setSyncBadge('ok','‚úÖ Refresh'); return true; }
    else throw new Error(d.error||'No schedule');
  } catch(err){ setSyncBadge('fail','‚ùå Retry'); console.error(err); return false; }
}

async function pushSchedule(){
  setSyncBadge('working','üíæ Saving');
  try {
    var r = await fetch(SCRIPT_URL+'?action=updateSchedule',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'updateSchedule',schedule:schedule})
    });
    var d = await r.json();
    if(d.success){ setSyncBadge('ok','‚úÖ Saved'); setTimeout(function(){setSyncBadge('ok','‚úÖ Refresh');},2000); }
    else throw new Error(d.error);
  } catch(err){ setSyncBadge('fail','‚ùå Save failed'); console.error(err); }
}

async function manualRefresh(){ var ok=await fetchSchedule(); if(ok)renderAll(); }

// ============================================================
// BOOT
// ============================================================
async function boot(){
  renderShell();
  renderAll(); // render immediately with hardcoded data ‚Äî reschedule buttons visible right away
  // Try to sync with Google Sheets in background
  var ok = await fetchSchedule();
  if(ok) renderAll(); // re-render with live data if available
  // NO auto-refresh ‚Äî click the green badge to manually refresh
}
boot();

// ============================================================
// SHELL
// ============================================================
function renderShell(){
  document.getElementById('app').innerHTML =
    '<div class="header"><h1>üéØ PQ Dart League</h1><p>Season 10 ‚Äì Winter 2025</p></div>'+
    '<div class="venue">üìç Cheers ‚Äì 3 Boards | Board 3 = Makeup</div>'+
    '<div class="rules"><h4>üìä Scoring</h4><ul>'+
      '<li><strong>Match (Best of 5):</strong> Winner 4pts ¬∑ Loser 0.5/game won</li>'+
      '<li><strong>Tied 1-1 or 2-2:</strong> 2pts each</li>'+
      '<li><strong>H2H (4 games):</strong> 0.5pts/game ¬∑ Unplayed split evenly</li></ul></div>'+
    '<div class="tabs">'+
      '<button class="tab on" onclick="showTab(\'schedule\',this)">üìÖ Schedule</button>'+
      '<button class="tab" onclick="showTab(\'standings\',this)">üèÜ Teams</button>'+
      '<button class="tab" onclick="showTab(\'gamestats\',this)">üìä Game Stats</button>'+
      '<button class="tab" onclick="showTab(\'players\',this)">üë§ Players</button>'+
    '</div>'+
    '<div class="card">'+
      '<div id="schedule" class="tab-pane on"></div>'+
      '<div id="standings" class="tab-pane"></div>'+
      '<div id="gamestats" class="tab-pane"></div>'+
      '<div id="players" class="tab-pane"></div>'+
    '</div>';
}

function showTab(id,btn){
  document.querySelectorAll('.tab-pane').forEach(function(p){p.classList.remove('on')});
  document.querySelectorAll('.tab').forEach(function(b){b.classList.remove('on')});
  document.getElementById(id).classList.add('on');
  btn.classList.add('on');
}

// ============================================================
// HELPERS
// ============================================================
function hasScores(m){ return m.matchScore1!==null&&m.matchScore2!==null&&m.matchScore1!==''&&m.matchScore2!==''; }
function pName(t,n){ return n===1?TEAMS[t].p1:TEAMS[t].p2; }

function calcPoints(m){
  if(!hasScores(m))return{t1:0,t2:0};
  var s1=parseInt(m.matchScore1),s2=parseInt(m.matchScore2),t1=0,t2=0;
  if(s1===s2&&(s1===1||s1===2)){t1=t2=2;}
  else if(s1>s2){t1=4;t2=s2*0.5;}
  else{t2=4;t1=s1*0.5;}
  if(m.h2h&&m.h2h.length){
    var h1=0,h2=0,played=0;
    m.h2h.forEach(function(g){ if(g.w){played++;if(Math.floor(g.w)===m.team1)h1++;else h2++;} });
    var unplayed=4-played;
    t1+=h1*0.5+(unplayed*0.5)/2;
    t2+=h2*0.5+(unplayed*0.5)/2;
  } else { t1+=1; t2+=1; }
  return{t1:t1,t2:t2};
}

function renderAll(){ renderSchedule(); renderStandings(); renderGameStats(); renderPlayers(); }

// ============================================================
// SCHEDULE
// ============================================================
function renderSchedule(){
  var html='';
  schedule.forEach(function(week,wIdx){
    html+='<div class="week"><div class="week-head"><span>Week '+week.week+' ‚Äì '+week.date+'</span><span class="gt-badge">'+week.type+'</span></div>';
    week.timeSlots.forEach(function(slot,sIdx){
      html+='<div class="slot"><div class="slot-time">üïê '+slot.time+'</div><div class="boards">';
      slot.boards.forEach(function(board,bIdx){ html+=renderBoard(board,wIdx,sIdx,bIdx,week); });
      html+='</div></div>';
    });
    html+='</div>';
  });
  document.getElementById('schedule').innerHTML=html;
}

function renderBoard(b,wIdx,sIdx,bIdx,week){
  // Cancelled (rescheduled away)
  if(b.cancelled&&!b.filledFromReschedule){
    return '<div class="board cancelled"><div class="blbl">Board '+b.board+'</div>'+
      '<div style="color:#c62828;font-weight:600;text-align:center;padding:14px">‚ùå Rescheduled</div></div>';
  }
  // Empty makeup board
  if(b.makeup&&!b.team1){
    return '<div class="board makeup"><div class="blbl">Board 3</div>'+
      '<div style="color:#f57c00;font-weight:600;font-size:.84rem">üîß Makeup Board</div>'+
      '<div style="color:#888;font-size:.82rem;font-style:italic">Available for rescheduled games</div></div>';
  }
  // TBD placeholder (playoffs etc)
  if(b.note&&!b.team1){
    return '<div class="board"><div class="blbl">Board '+b.board+'</div>'+
      '<div style="text-align:center;padding:14px;color:#999;font-style:italic">'+b.note+'</div></div>';
  }
  if(!b.team1||!b.team2) return '';

  var isRescheduled=!!b.rescheduled;
  var isFilledFromReschedule=!!b.filledFromReschedule;
  var scored=hasScores(b);
  var readOnly=isFilledFromReschedule;

  // Auto-generate H2H structure if missing
  if(!b.h2hNA&&(!b.h2h||!b.h2h.length)){
    b.h2h=[
      {p1:parseFloat(b.team1+'.1'),p2:parseFloat(b.team2+'.1'),w:null},
      {p1:parseFloat(b.team1+'.1'),p2:parseFloat(b.team2+'.2'),w:null},
      {p1:parseFloat(b.team1+'.2'),p2:parseFloat(b.team2+'.1'),w:null},
      {p1:parseFloat(b.team1+'.2'),p2:parseFloat(b.team2+'.2'),w:null}
    ];
  }

  var cls='board'+(isRescheduled?' makeup booked':isFilledFromReschedule?' filled':'');
  var html='<div class="'+cls+'"><div class="blbl">Board '+b.board+'</div>';

  if(isRescheduled){
    html+='<div class="rescheduled-badge">Rescheduled from Week '+b.trueOriginalWeek+'</div>';
    html+='<div class="orig-info"><strong>Original:</strong> Week '+b.trueOriginalWeek+' ¬∑ '+(b.trueOriginalType||'?')+' ¬∑ <strong>Points count for Week '+b.trueOriginalWeek+'</strong></div>';
  }
  if(isFilledFromReschedule){
    html+='<div class="orig-info">üìã Results from rescheduled game ‚Äì read only</div>';
  }

  // Match scores
  html+='<div style="margin-bottom:5px;font-weight:600;font-size:.75rem;color:#666">Match Play (Best of 5):</div>';
  html+=teamRow(b.team1,'matchScore1',b,wIdx,sIdx,bIdx,readOnly);
  html+='<div class="vs">VS</div>';
  html+=teamRow(b.team2,'matchScore2',b,wIdx,sIdx,bIdx,readOnly);

  // H2H
  html+='<div class="h2h"><div class="h2h-head">Head to Head (4 games):</div>';
  if(b.h2hNA){
    html+='<div style="color:#999;font-style:italic;text-align:center;padding:6px;font-size:.84rem">Individual game data N/A</div>';
  } else if(b.h2h){
    b.h2h.forEach(function(g,gIdx){
      var p1t=Math.floor(g.p1), p1n=Math.round((g.p1-p1t)*10);
      var p2t=Math.floor(g.p2), p2n=Math.round((g.p2-p2t)*10);
      var n1=pName(p1t,p1n), n2=pName(p2t,p2n);
      html+='<div class="h2h-row"><span class="players">'+n1+' vs '+n2+'</span>'+
        '<select '+(readOnly?'disabled':'')+' onchange="updateH2H('+wIdx+','+sIdx+','+bIdx+','+gIdx+',this.value)">'+
        '<option value="">--</option>'+
        '<option value="'+g.p1+'" '+(g.w===g.p1?'selected':'')+'>'+n1+'</option>'+
        '<option value="'+g.p2+'" '+(g.w===g.p2?'selected':'')+'>'+n2+'</option></select></div>';
    });
  }
  html+='</div>';

  // Points display
  if(scored){
    var pts=calcPoints(b);
    html+='<div class="pts-row'+(pts.t1===pts.t2?' tied':'')+'"><span><strong>#'+b.team1+':</strong> '+pts.t1.toFixed(1)+' pts</span><span><strong>#'+b.team2+':</strong> '+pts.t2.toFixed(1)+' pts</span></div>';
  }

  // Action buttons ‚Äî reschedule only on unplayed, non-readonly games
  if(!scored&&!readOnly){
    html+='<div class="actions">'+
      '<button class="btn-sm btn-warn" onclick="openReschedule('+wIdx+','+sIdx+','+bIdx+')">üìÖ Reschedule</button>';
    if(isRescheduled){
      html+='<button class="btn-sm btn-danger" onclick="removeReschedule('+wIdx+','+sIdx+','+bIdx+')">‚ùå Remove</button>';
    }
    html+='</div>';
  }

  html+='</div>';
  return html;
}

function teamRow(teamNum,field,b,wIdx,sIdx,bIdx,readOnly){
  var team=TEAMS[teamNum];
  return '<div class="team-row">'+
    '<div class="name"><span class="num">#'+teamNum+'</span>'+team.name+'</div>'+
    '<input type="number" min="0" max="3" class="score-in" value="'+(b[field]!=null?b[field]:'')+'" placeholder="0" '+
    (readOnly?'disabled':'onchange="updateScore('+wIdx+','+sIdx+','+bIdx+',\''+field+'\',this.value)"')+
    '></div>';
}

// ============================================================
// SCORE / H2H UPDATES
// ============================================================
async function updateScore(wIdx,sIdx,bIdx,field,val){
  var m=schedule[wIdx].timeSlots[sIdx].boards[bIdx];
  m[field]=val===''?null:val;
  if(m.rescheduled&&hasScores(m)&&m.trueOriginalWeek!=null) fillOriginalSlot(m);
  renderAll();
  await pushSchedule();
}

async function updateH2H(wIdx,sIdx,bIdx,gIdx,val){
  var m=schedule[wIdx].timeSlots[sIdx].boards[bIdx];
  if(!m.h2h) m.h2h=[];
  if(!m.h2h[gIdx]){
    m.h2h[gIdx]={
      p1:parseFloat(m.team1+'.'+(gIdx<2?1:2)),
      p2:parseFloat(m.team2+'.'+(gIdx%2===0?1:2)),
      w:null
    };
  }
  m.h2h[gIdx].w=val?parseFloat(val):null;
  renderAll();
  await pushSchedule();
}

function fillOriginalSlot(rescMatch){
  var origWeek=schedule.find(function(w){return w.week===rescMatch.trueOriginalWeek;});
  if(!origWeek) return;
  var origSlot=origWeek.timeSlots[rescMatch.trueOriginalSlot];
  if(!origSlot) return;
  var origBoard=origSlot.boards[rescMatch.trueOriginalBoard];
  if(!origBoard||!origBoard.cancelled) return;
  origBoard.team1=rescMatch.team1;
  origBoard.team2=rescMatch.team2;
  origBoard.matchScore1=rescMatch.matchScore1;
  origBoard.matchScore2=rescMatch.matchScore2;
  origBoard.h2h=JSON.parse(JSON.stringify(rescMatch.h2h||[]));
  origBoard.h2hNA=rescMatch.h2hNA||false;
  origBoard.filledFromReschedule=true;
  delete origBoard.cancelled;
}

// ============================================================
// RESCHEDULE MODAL
// ============================================================
function findSlots(team1,team2,fromWeekNum){
  var fromWeek=schedule.find(function(w){return w.week===fromWeekNum;});
  var fromIdx=schedule.indexOf(fromWeek);
  var result=[];
  schedule.forEach(function(week,wIdx){
    if(wIdx<=fromIdx) return;
    week.timeSlots.forEach(function(slot,sIdx){
      var b3=slot.boards[2];
      if(!b3||!b3.makeup||b3.team1) return;
      var busy=false;
      slot.boards.forEach(function(bd){
        if(bd.team1===team1||bd.team2===team1||bd.team1===team2||bd.team2===team2) busy=true;
      });
      if(!busy) result.push({wIdx:wIdx,sIdx:sIdx,week:week.week,date:week.date,type:week.type,time:slot.time});
    });
  });
  return result;
}

function openReschedule(wIdx,sIdx,bIdx){
  var m=schedule[wIdx].timeSlots[sIdx].boards[bIdx];
  var week=schedule[wIdx];
  rescheduleCtx={wIdx:wIdx,sIdx:sIdx,bIdx:bIdx};
  selectedSlot=null;

  var origWeek=m.trueOriginalWeek||week.week;
  var origType=m.trueOriginalType||week.type;

  document.getElementById('modalTitle').textContent=m.rescheduled?'Reschedule Again':'Reschedule Match';

  var slots=findSlots(m.team1,m.team2,week.week);
  var html='<div class="match-box"><strong>#'+m.team1+' '+TEAMS[m.team1].name+' vs #'+m.team2+' '+TEAMS[m.team2].name+'</strong>'+
    '<br><span class="gt-sm">'+origType+'</span> ¬∑ <span style="font-size:.8rem;color:#666">Originally Week '+origWeek+' ¬∑ Points count for Week '+origWeek+'</span></div>';

  if(slots.length){
    html+='<div class="slots-wrap"><h4>‚úÖ Available Board 3 Slots</h4>';
    slots.forEach(function(s){
      html+='<div class="slot-opt" onclick="pickSlot('+s.wIdx+','+s.sIdx+',this)">'+
        '<strong>Week '+s.week+'</strong> ('+s.date+') ‚Äì '+s.time+'<br>'+
        '<span style="font-size:.82rem;color:#666">'+s.type+' ¬∑ Board 3</span></div>';
    });
    html+='</div>';
  } else {
    html+='<div class="no-slots">‚ö†Ô∏è No available Board 3 slots where both teams are free.</div>';
  }

  document.getElementById('modalBody').innerHTML=html;
  document.getElementById('confirmBtn').disabled=!slots.length;
  document.getElementById('modalBg').classList.add('on');
}

function pickSlot(wIdx,sIdx,el){
  document.querySelectorAll('.slot-opt').forEach(function(e){e.classList.remove('sel')});
  el.classList.add('sel');
  selectedSlot={wIdx:wIdx,sIdx:sIdx};
}

function closeModal(){
  document.getElementById('modalBg').classList.remove('on');
  rescheduleCtx=null;
  selectedSlot=null;
}

async function confirmReschedule(){
  if(!selectedSlot){ alert('Pick a slot first.'); return; }

  var src=schedule[rescheduleCtx.wIdx].timeSlots[rescheduleCtx.sIdx].boards[rescheduleCtx.bIdx];
  var srcWeek=schedule[rescheduleCtx.wIdx];
  var tgt=schedule[selectedSlot.wIdx].timeSlots[selectedSlot.sIdx].boards[2];

  // Preserve true original across re-reschedules
  var origW = src.trueOriginalWeek!==undefined ? src.trueOriginalWeek : srcWeek.week;
  var origS = src.trueOriginalSlot!==undefined ? src.trueOriginalSlot : rescheduleCtx.sIdx;
  var origB = src.trueOriginalBoard!==undefined ? src.trueOriginalBoard : rescheduleCtx.bIdx;
  var origT = src.trueOriginalType || srcWeek.type;

  // Fill target Board 3
  tgt.team1=src.team1;
  tgt.team2=src.team2;
  tgt.matchScore1=src.matchScore1;
  tgt.matchScore2=src.matchScore2;
  tgt.h2h=src.h2h?JSON.parse(JSON.stringify(src.h2h)):[];
  tgt.h2hNA=src.h2hNA||false;
  tgt.makeup=false;
  tgt.rescheduled=true;
  tgt.trueOriginalWeek=origW;
  tgt.trueOriginalSlot=origS;
  tgt.trueOriginalBoard=origB;
  tgt.trueOriginalType=origT;

  // Clear source
  if(src.rescheduled){
    // Was already on Board 3 ‚Äî just clear it back to makeup
    src.team1=src.team2=src.matchScore1=src.matchScore2=null;
    src.h2h=[]; src.h2hNA=false; src.makeup=true; src.rescheduled=false;
    delete src.trueOriginalWeek; delete src.trueOriginalSlot;
    delete src.trueOriginalBoard; delete src.trueOriginalType;
  } else {
    // Original board ‚Äî mark cancelled
    src.cancelled=true;
    src.matchScore1=src.matchScore2=null; src.h2h=[]; src.h2hNA=false;
  }

  closeModal();
  renderAll();
  await pushSchedule();
}

async function removeReschedule(wIdx,sIdx,bIdx){
  if(!confirm('Remove this rescheduled match and restore original slot?')) return;
  var m=schedule[wIdx].timeSlots[sIdx].boards[bIdx];

  // Restore original slot back to cancelled state
  if(m.trueOriginalWeek!=null){
    var ow=schedule.find(function(w){return w.week===m.trueOriginalWeek;});
    if(ow){
      var os=ow.timeSlots[m.trueOriginalSlot];
      if(os){
        var ob=os.boards[m.trueOriginalBoard];
        if(ob&&ob.filledFromReschedule){
          ob.cancelled=true;
          delete ob.filledFromReschedule;
          ob.matchScore1=ob.matchScore2=null; ob.h2h=[]; ob.h2hNA=false;
        }
      }
    }
  }

  // Clear this Board 3 back to makeup
  m.team1=m.team2=m.matchScore1=m.matchScore2=null;
  m.h2h=[]; m.h2hNA=false; m.makeup=true; m.rescheduled=false;
  delete m.trueOriginalWeek; delete m.trueOriginalSlot;
  delete m.trueOriginalBoard; delete m.trueOriginalType;

  renderAll();
  await pushSchedule();
}

// ============================================================
// STANDINGS
// ============================================================
function calcStandings(){
  var stats={};
  Object.keys(TEAMS).forEach(function(t){ stats[t]={matches:0,matchPts:0,h2hPts:0,total:0}; });
  schedule.forEach(function(week){
    week.timeSlots.forEach(function(slot){
      slot.boards.forEach(function(b){
        if(!b.team1||!b.team2||b.cancelled||b.rescheduled||!hasScores(b)) return;
        var s1=parseInt(b.matchScore1),s2=parseInt(b.matchScore2),t1mp=0,t2mp=0;
        if(s1===s2&&(s1===1||s1===2)){t1mp=t2mp=2;}
        else if(s1>s2){t1mp=4;t2mp=s2*0.5;}
        else{t2mp=4;t1mp=s1*0.5;}
        var pts=calcPoints(b);
        stats[b.team1].matches++; stats[b.team2].matches++;
        stats[b.team1].matchPts+=t1mp; stats[b.team2].matchPts+=t2mp;
        stats[b.team1].h2hPts+=pts.t1-t1mp; stats[b.team2].h2hPts+=pts.t2-t2mp;
        stats[b.team1].total+=pts.t1; stats[b.team2].total+=pts.t2;
      });
    });
  });
  return stats;
}

function renderStandings(){
  var stats=calcStandings();
  var rows=Object.keys(stats).map(function(t){
    var s=stats[t]; s.num=parseInt(t); s.avg=s.matches?s.total/s.matches:0; return s;
  }).sort(function(a,b){return b.total-a.total||b.avg-a.avg||a.num-b.num;});

  var badges=['p1','p2','p3'], suf=['st','nd','rd'];
  var html='<div class="payouts"><h3>üí∞ Prize Payouts</h3><div class="payout-grid">'+
    '<div class="payout-card"><strong>Season ($1,000 min)</strong><br>1st: $360 ¬∑ 2nd: $200 ¬∑ 3rd: $140</div>'+
    '<div class="payout-card"><strong>Aaron Bell Tournament</strong><br>1st: $160 ¬∑ 2nd: $80 ¬∑ 3rd: $60</div></div></div>';

  html+='<table class="tbl"><thead><tr>'+
    '<th style="text-align:center">Place</th><th style="text-align:center">#</th><th>Team</th><th>Players</th>'+
    '<th style="text-align:center">GP</th><th style="text-align:center">Match</th>'+
    '<th style="text-align:center">H2H</th><th style="text-align:center">Total</th><th style="text-align:center">Avg</th></tr></thead><tbody>';

  rows.forEach(function(r,i){
    var cls=i<3?badges[i]:'p-';
    var sf=i<3?suf[i]:'th';
    var t=TEAMS[r.num];
    html+='<tr>'+
      '<td style="text-align:center"><span class="place '+cls+'">'+(i+1)+sf+'</span></td>'+
      '<td style="text-align:center;font-weight:600">'+r.num+'</td>'+
      '<td style="font-weight:600">'+t.name+'</td>'+
      '<td style="color:#666">'+t.p1+' & '+t.p2+'</td>'+
      '<td style="text-align:center">'+r.matches+'</td>'+
      '<td style="text-align:center">'+r.matchPts.toFixed(1)+'</td>'+
      '<td style="text-align:center">'+r.h2hPts.toFixed(1)+'</td>'+
      '<td style="text-align:center;font-weight:600">'+r.total.toFixed(1)+'</td>'+
      '<td style="text-align:center;font-weight:600;color:#1e3c72">'+r.avg.toFixed(2)+'</td></tr>';
  });
  html+='</tbody></table>';
  document.getElementById('standings').innerHTML=html;
}

// ============================================================
// GAME STATS
// ============================================================
function renderGameStats(){
  var byType={};
  schedule.forEach(function(week){
    var gt=week.type;
    if(!byType[gt]){ byType[gt]={}; Object.keys(TEAMS).forEach(function(t){byType[gt][t]={played:0,wins:0,losses:0,ties:0,pts:0};}); }
    week.timeSlots.forEach(function(slot){
      slot.boards.forEach(function(b){
        if(!b.team1||!b.team2||b.cancelled||b.rescheduled||!hasScores(b)) return;
        var s1=parseInt(b.matchScore1),s2=parseInt(b.matchScore2);
        var pts=calcPoints(b);
        byType[gt][b.team1].played++; byType[gt][b.team2].played++;
        byType[gt][b.team1].pts+=pts.t1; byType[gt][b.team2].pts+=pts.t2;
        if(s1>s2){byType[gt][b.team1].wins++;byType[gt][b.team2].losses++;}
        else if(s2>s1){byType[gt][b.team2].wins++;byType[gt][b.team1].losses++;}
        else if(s1===s2&&(s1===1||s1===2)){byType[gt][b.team1].ties++;byType[gt][b.team2].ties++;}
      });
    });
  });
  var html='';
  Object.keys(byType).forEach(function(gt){
    var rows=Object.keys(byType[gt]).map(function(t){
      var s=byType[gt][t]; s.num=parseInt(t); s.wp=s.played?(s.wins/s.played*100).toFixed(1):0; return s;
    }).filter(function(r){return r.played>0;}).sort(function(a,b){return b.pts-a.pts;});
    if(!rows.length) return;
    html+='<div class="stat-card"><h3>'+gt+'</h3><table class="tbl"><thead><tr>'+
      '<th>#</th><th>Team</th><th style="text-align:center">GP</th><th style="text-align:center">W</th>'+
      '<th style="text-align:center">L</th><th style="text-align:center">T</th><th style="text-align:center">Win%</th>'+
      '<th style="text-align:center">Pts</th></tr></thead><tbody>';
    rows.forEach(function(r){
      html+='<tr><td style="font-weight:600">'+r.num+'</td><td>'+TEAMS[r.num].name+'</td>'+
        '<td style="text-align:center">'+r.played+'</td>'+
        '<td style="text-align:center;color:#4caf50;font-weight:600">'+r.wins+'</td>'+
        '<td style="text-align:center;color:#e53935">'+r.losses+'</td>'+
        '<td style="text-align:center;color:#ff9800">'+r.ties+'</td>'+
        '<td style="text-align:center;font-weight:600">'+r.wp+'%</td>'+
        '<td style="text-align:center;font-weight:600;color:#1e3c72">'+r.pts.toFixed(1)+'</td></tr>';
    });
    html+='</tbody></table></div>';
  });
  document.getElementById('gamestats').innerHTML=html||'<p style="text-align:center;color:#999;padding:24px">No games played yet.</p>';
}

// ============================================================
// PLAYER STATS
// ============================================================
function renderPlayers(){
  var ps={};
  Object.keys(TEAMS).forEach(function(t){
    ps[t+'.1']={name:TEAMS[t].p1,team:parseInt(t),gp:0,w:0,l:0};
    ps[t+'.2']={name:TEAMS[t].p2,team:parseInt(t),gp:0,w:0,l:0};
  });
  schedule.forEach(function(week){
    week.timeSlots.forEach(function(slot){
      slot.boards.forEach(function(b){
        if(!b.h2h||b.cancelled||b.rescheduled) return;
        b.h2h.forEach(function(g){
          if(!g.w) return;
          var k1=g.p1.toFixed(1), k2=g.p2.toFixed(1), wk=g.w.toFixed(1);
          if(ps[k1]){ps[k1].gp++;if(wk===k1)ps[k1].w++;else ps[k1].l++;}
          if(ps[k2]){ps[k2].gp++;if(wk===k2)ps[k2].w++;else ps[k2].l++;}
        });
      });
    });
  });
  var rows=Object.values(ps).sort(function(a,b){return b.w-a.w||(b.gp?b.w/b.gp:0)-(a.gp?a.w/a.gp:0);});
  var html='<table class="tbl"><thead><tr><th>Player</th><th>Team</th>'+
    '<th style="text-align:center">GP</th><th style="text-align:center">W</th>'+
    '<th style="text-align:center">L</th><th style="text-align:center">Win %</th></tr></thead><tbody>';
  rows.forEach(function(r){
    var wp=r.gp?(r.w/r.gp*100).toFixed(1):'0.0';
    html+='<tr><td style="font-weight:600">'+r.name+'</td>'+
      '<td style="color:#666">#'+r.team+' '+TEAMS[r.team].name+'</td>'+
      '<td style="text-align:center">'+r.gp+'</td>'+
      '<td style="text-align:center;color:#4caf50;font-weight:600">'+r.w+'</td>'+
      '<td style="text-align:center;color:#e53935">'+r.l+'</td>'+
      '<td style="text-align:center;font-weight:600;color:#1e3c72">'+wp+'%</td></tr>';
  });
  html+='</tbody></table>';
  document.getElementById('players').innerHTML=html;
}
</script>
</body>
</html>
